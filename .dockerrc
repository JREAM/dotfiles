#!/bin/bash
# ╔═════════════════════════════════════════════════════════════════╗
# ║ DOCKERRC                                                        ║
# ╠═════════════════════════════════════════════════════════════════╣
# ║ - Sourced from .bashrc                                          ║
# ║                                                                 ║
# ║ @note: Using rm<i|c|v> (i:images, c:containers, v:volumes>      ║
# ║                                                                 ║
# ║ < Built-in 1.13+ >                                              ║
# ║ (1): Remove all stopped containers:                             ║
# ║  $ docker container prune                                       ║
# ║  $ docker container prune --filter "until=1w"                   ║
# ║ (2): System Prune:                                              ║
# ║  $ docker system prune -a                                       ║
# ╚═════════════════════════════════════════════════════════════════╝


# Used for Settings, please do not change.
# ___________________________________________________________________
DIR_DB='/data/db'
DIR_CONF='/data/conf'

# ┌─────────────────────────────────────────────────────────────────┐
# │ Settings                                                        │
# ├─────────────────────────────────────────────────────────────────┤
# │ These only install if you run them with functions below.        │
# │                                                                 │
# │ @note   Different ports are use for non-conflict                │
# │         with local setups.                                      │
# └─────────────────────────────────────────────────────────────────┘

# @TODO: Add destroyable so its easier for user, multi instance maybe?

DIR_WWW="${HOME}/projects"      # Local HTTP Content serve location.

MY_PORTAINER_PORT=9500
MY_PORTAINER_NAME="portainer-local"
IMAGE_PORTAINER="portainer/portainer"

MY_SWAGGER_EDITOR_PORT=9600
MY_SWAGGER_EDITOR_NAME="swagger-local"
IMAGE_SWAGGER_EDITOR="swaggerapi/swagger-editor"

MY_APACHE_NAME="apache-local"
MY_APACHE_PORT="82"             # 80 is defau   lt
IMAGE_APACHE="apache:2-alpine"

MY_REDIS_NAME="redis-local"
MY_REDIS_PORT=6300              # 6379 is default
IMAGE_REDIS="redis:3-alpine"

MY_MONGO_NAME="mongo-local"
MY_MONGO_PORT=2700              # 27017 is default
IMAGE_MONGO="mongo:3.4"

MY_MYSQL_NAME="mysql-local"
MY_MYSQL_PORT=3300              # 3306 is default
MY_MYSQL_ROOT_PASSWORD="root"   # root Password
IMAGE_MYSQL="mysql:5.7"      # You could swap w/Percona, Maria, Mysql.

MY_ELK_NAME="elk-local"
MY_ELK_PORT_ELASTICSEARCH=9200  # 9200 Default
MY_ELK_PORT_KIBANA=5601         # 5601 Default (http://localhost:5601)
MY_ELK_PORT_LOGSTASH=5044       # 5044 Default
IMAGE_ELK="sebp/elk:600"

# ┌─────────────────────────────────────────────────────────────────┐
# │ Aliases                                                         │
# ├─────────────────────────────────────────────────────────────────┤
# │ For Docker Compose                                              │
# └─────────────────────────────────────────────────────────────────┘
alias dco="docker-compose"
alias dco-l="docker-compose logs"
alias dco-log="docker-compose logs"
alias dco-logs="docker-compose logs"
alias dco-lf="docker-compose logs -f"
alias dco-logf="docker-compose logs -f"
alias dco-logsf="docker-compose logs -f"
alias dco-reboot="docker-compose down && docker-compose up -d"
alias dco-fresh="docker-compose kill && docker-compose down && docker-compose up --build -d"
alias dco-down="docker-compose down"
alias dco-up="docker-compose up -d"
alias dco-stop="docker-compose stop"
alias dco-kill="docker-compose kill"

# ┌─────────────────────────────────────────────────────────────────┐
# │ Aliases/Function                                                │
# ├─────────────────────────────────────────────────────────────────┤
# │ For Docker                                                      │
# └─────────────────────────────────────────────────────────────────┘
# ___________________________________________________________________
#
#                       ALIASES/FUNCTIONS
#                             Docker
# ___________________________________________________________________
alias docker-kill-all="docker kill $(docker ps -q)"

# Shortcut for docker compose without the dash
# Appearing to be useless :)
function docker() {
    echo $1
  if [ "$1" = "compose" ]
  then
    shift
    docker-compose "$@"
  else
    command docker "$@"
  fi
}

# UTIL: Get last ID
function docker-last-id() {
    docker ps -l -q
}

# IMAGES: Does Container Exist?
function docker-exists() {
    if [ -z $1 ]; then
        echo "Missing argument for image name."
        return
    fi
    return $(docker images -q $1)  # Returns ID or Nothing
}

# IMAGES: Remove Danglish
function docker-rmi-dangling() {
    docker images -a -q --filter 'dangling=true' | xargs docker rmi
}

# IMAGES: Remove ALL
function docker-rmi-all() {
    docker rmi $(docker images -a -q)
}

# VOLUMES: Remove Dangling
function docker-rmv-dangling() {
    docker volume rm $(docker volume ls -q -f dangling=true)
}

# CONTAINERS: Stop/Kill All
function docker-stop-all {
    docker stop $(docker ps -q)
}

function docker-kill-all {
    docker kill $(docker ps -q)
}

# CONTAINERSL Remove ALL
function docker-rmc-all() {
    docker kill $(docker ps -q)
    docker ps -aq | xargs docker rm -fv
}

# CONTAINERS: Remove OLD (Weeks Ago)
function docker-rm-containers-old() {
    docker ps -a | grep 'weeks ago' | awk '{print $1}' | xargs docker rm
}

# ___________________________________________________________________
#
#                         REUSABLE CMDS
#
#     @note Odd Naming used to prevent any global command collisions
# ___________________________________________________________________
# function _dockr-setup() {
#     echo "Setting up $1"
# }
# function _dockr-start() {
#     echo "Starting: $1 ..."
#     docker start $1
# }
# function _dockr-stop() {
#     echo "Stopping: $1 ..."
#     docker stop $1
# }
# function _dockr-rm() {
#     echo "Removing Container: $1 ..."
#     docker rm $1
# }

# function _dockr-rmi() {
#     echo "Removing Image: $1 ..."
#     docker rmi $1
# }

# function _docker-rmv() {
#     echo "Removing Attached Volume: $1 ..."
#     read -p "Are you sure? This cannot be undone [y/N]: " yn
#     if [ p == 'y' || p == 'Y' ]; then
#         docker rmi $1
#     fi
# }

# ┌─────────────────────────────────────────────────────────────────┐
# │ Portainer                                                       │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function portainer-setup() {
    docker volume create portainer_data
    docker run -d --name=$MY_PORTAINER_NAME -p $MY_PORTAINER_PORT:9000 -v /var/run/docker.sock:/var/run/docker.sock -v /data/db/portainer_data:/data $IMAGE_PORTAINER
}
alias portainer-setup='portainer-setup'

function portainer-up() {
    docker start $MY_PORTAINER_NAME
}

function portainer-stop() {
    docker stop $MY_PORTAINER_NAME
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ Swagger Editor                                                  │
# ├─────────────────────────────────────────────────────────────────┤
# │ @recommend  $ npm i -g swagger                                  │
# └─────────────────────────────────────────────────────────────────┘
function swagger-setup() {
    docker run -d --name=$MY_SWAGGER_EDITOR_NAME -p $MY_SWAGGER_EDITOR_PORT:8080 $IMAGE_SWAGGER_EDITOR
    echo -e "@recommended: npm i -g swagger  (Additional CLI for Swagger)\n"
}

function swagger-up() {
    docker start $MY_SWAGGER_EDITOR_NAME
}

function swagger-stop() {
    docker stop $MY_SWAGGER_EDITOR_NAME
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ Redis                                                           │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function redis-setup() {
    sudo mkdir -p /data
    if [ ! -f $DIR_CONF/redis.conf ]; then
        echo "You need are missing ${DIR_CONF}/redis.conf, see https://github.com/jream/dotfiles.git under a docker folder"
        exit 1
    fi
    docker run -d -v $DIR_CONF/redis.conf:/usr/local/etc/redis/redis.conf --name=$MY_REDIS_NAME -p $MY_REDIS_PORT:6379 $IMAGE_REDIS
}

function redis-up() {
    docker start $MY_REDIS_NAME
}

function redis-stop() {
    docker stop $MY_REDIS_NAME
}

function redis-connect() {
    docker exec -i $MY_REDIS_NAME redis-cli
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ Apache                                                          │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function apache-setup() {
    docker run -d -v "$DIR_WWW":/usr/local/apache2/htdocs/ --name=$MY_APACHE_NAME -p $MY_APACHE_PORT:80 $IMAGE_APACHE
}

function apache-up() {
    docker start $MY_APACHE_NAME
}

function apache-stop() {
    docker stop $MY_APACHE_NAME
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ Mongo                                                           │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function mongo-setup() {
    echo "Creating local directory to persist data"
    sudo mkdir $DIR_DB/mongo/$MY_MONGO_NAME
    docker run -d -v $DIR_DB/mongo/$MY_MONGO_NAME --name=$MY_MONGO_NAME -p $MY_MONGO_PORT:27017 $IMAGE_MONGO
}

function mongo-up() {
    docker start $MY_MONGO_NAME
}

function mongo-stop() {
    docker stop $MY_MONGO_NAME
}

function mongo-connect() {
    docker exec -it $MY_MONGO_NAME mongo
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ MySQL                                                           │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function mysql-setup() {
    echo "Creating local directory to persist data"
    sudo mkdir $DIR_DB/mysql/$MY_MYSQL_NAME
    docker run -d -v $DIR_DB/mysql/$MY_MYSQL_NAME:/var/lib/mysql --name=$MY_MYSQL_NAME -p $MY_MYSQL_PORT:3306 -e MYSQL_ROOT_PASSWORD=$MY_MYSQL_ROOT_PASSWORD $IMAGE_MYSQL
}

function mysql-up() {
    docker start $MY_MYSQL_NAME
}

function mysql-stop() {
    docker stop $MY_MYSQL_NAME
}

function mysql-connect() {
    docker exec -it $MY_MYSQL_NAME mysql -uroot -p$MY_MYSQL_ROOT_PASSWORD
}

# ┌─────────────────────────────────────────────────────────────────┐
# │ Redis                                                           │
# ├─────────────────────────────────────────────────────────────────┤
# └─────────────────────────────────────────────────────────────────┘
function elk-setup() {
    echo "Creating local directory to persist data"
    docker run -v $DIR_DB/elasticsearch/$MY_ELK_NAME:/var/lib/elasticsearch -p $MY_ELK_PORT_ELASTICSEARCH:9200 -p $MY_ELK_PORT_KIBANA:5601 -p $MY_ELK_PORT_LOGSTASH:5044 -it --name $MY_ELK_NAME $IMAGE_ELK
}

function elk-up() {
    docker start $MY_ELK_NAME
}

function elk-stop() {
    docker stop $MY_ELK_NAME
}

# End of File
